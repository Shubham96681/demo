name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p $HOME/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > $HOME/.ssh/ec2_key.pem
          chmod 600 $HOME/.ssh/ec2_key.pem
          ls -la $HOME/.ssh/
          cat $HOME/.ssh/ec2_key.pem | head -n 1

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key_path: /home/runner/.ssh/ec2_key.pem
          timeout: 30s
          debug: true
          script: |
            # Navigate to project directory (create if doesn't exist)
            if [ ! -d "/var/www/flask-cicd-demo" ]; then
              sudo mkdir -p /var/www
              cd /var/www
              sudo git clone https://github.com/${{ github.repository }}.git flask-cicd-demo
              sudo chown -R ec2-user:ec2-user /var/www/flask-cicd-demo
            fi
            
            cd /var/www/flask-cicd-demo
            git pull origin main || true
            
            # Setup virtual environment if doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Install Nginx if not installed (Amazon Linux)
            if ! command -v nginx &> /dev/null; then
              sudo yum update -y || sudo apt update -y
              sudo yum install -y nginx || sudo apt install -y nginx
            fi
            
            # Configure Nginx
            sudo tee /etc/nginx/conf.d/flask.conf > /dev/null <<EOF
            server {
                listen 80;
                server_name _;
                
                location / {
                    proxy_pass http://127.0.0.1:5000;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF
            
            # Remove default Nginx site if exists
            sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            # Test Nginx configuration
            sudo nginx -t
            
            # Restart Nginx
            sudo systemctl restart nginx || sudo service nginx restart
            sudo systemctl enable nginx || sudo chkconfig nginx on
            
            # Kill existing Gunicorn processes
            pkill gunicorn || true
            sleep 2
            
            # Start Gunicorn
            nohup gunicorn --bind 127.0.0.1:5000 --daemon wsgi:app > gunicorn.log 2>&1 || gunicorn --bind 127.0.0.1:5000 wsgi:app > gunicorn.log 2>&1 &
            sleep 3
            
            # Verify services are running
            echo "=== Gunicorn Status ==="
            ps aux | grep gunicorn | grep -v grep
            echo ""
            echo "=== Port 5000 Status ==="
            netstat -tlnp | grep 5000 || ss -tlnp | grep 5000 || echo "Port 5000 check skipped"
            echo ""
            echo "=== Nginx Status ==="
            sudo systemctl status nginx --no-pager || sudo service nginx status
            echo ""
            echo "=== Port 80 Status ==="
            netstat -tlnp | grep :80 || ss -tlnp | grep :80 || echo "Port 80 check skipped"
            echo ""
            echo "=== Testing local connection ==="
            curl -s http://127.0.0.1:5000 || curl -s http://localhost:5000 || echo "Local curl test failed"
            echo ""
            echo "=== Testing through Nginx ==="
            curl -s http://127.0.0.1:80 || curl -s http://localhost || echo "Nginx curl test failed"

