name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p $HOME/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > $HOME/.ssh/ec2_key.pem
          chmod 600 $HOME/.ssh/ec2_key.pem
          ls -la $HOME/.ssh/
          cat $HOME/.ssh/ec2_key.pem | head -n 1

      - name: Deploy to EC2
        continue-on-error: true
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key_path: /home/runner/.ssh/ec2_key.pem
          port: 22
          command_timeout: 30m
          script_stop: false
          debug: true
          script: |
            echo "Starting deployment..."
            
            # Install required dependencies
            if ! command -v git &> /dev/null; then
              echo "Installing git..."
              sudo yum install -y git || sudo apt-get install -y git
            fi
            
            if ! command -v python3 &> /dev/null; then
              echo "Installing Python3..."
              sudo yum install -y python3 python3-pip || sudo apt-get install -y python3 python3-pip python3-venv
            fi
            
            # Navigate to project directory (create if doesn't exist)
            if [ ! -d "/var/www/flask-cicd-demo" ]; then
              sudo mkdir -p /var/www
              cd /var/www
              sudo git clone https://github.com/${{ github.repository }}.git flask-cicd-demo
              sudo chown -R ec2-user:ec2-user /var/www/flask-cicd-demo
            fi
            
            cd /var/www/flask-cicd-demo
            git pull origin main || true
            
            # Setup virtual environment if doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
              # Fix permissions
              chmod +x venv/bin/activate
            fi
            
            source venv/bin/activate
            
            # Upgrade pip and install requirements
            pip install --upgrade pip || pip3 install --upgrade pip || python3 -m pip install --upgrade pip
            pip install -r requirements.txt || pip3 install -r requirements.txt || python3 -m pip install -r requirements.txt
            
            # Install Nginx and curl if not installed (Amazon Linux)
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo yum update -y || sudo apt update -y
              sudo yum install -y nginx || sudo apt install -y nginx
            fi
            
            if ! command -v curl &> /dev/null; then
              echo "Installing curl..."
              sudo yum install -y curl || sudo apt install -y curl
            fi
            
            # Remove ALL conflicting Nginx configs (thorough cleanup)
            sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
            sudo rm -f /etc/nginx/conf.d/default 2>/dev/null || true
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            sudo rm -f /etc/nginx/sites-available/default 2>/dev/null || true
            sudo rm -f /etc/nginx/conf.d/flask.conf 2>/dev/null || true
            
            # List all config files before creating new one
            echo "=== Existing Nginx config files ==="
            sudo ls -la /etc/nginx/conf.d/ || echo "conf.d directory check failed"
            
            # Configure Nginx - use default_server to ensure this takes precedence
            printf 'server {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n    server_name _;\n    \n    location / {\n        proxy_pass http://127.0.0.1:5000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n' | sudo tee /etc/nginx/conf.d/flask.conf > /dev/null
            
            # Verify the config file was created
            echo "=== Flask config file created ==="
            sudo cat /etc/nginx/conf.d/flask.conf
            echo ""
            
            # Verify no default config files remain
            echo "=== Checking for remaining default configs ==="
            sudo find /etc/nginx -name "*default*" -type f 2>/dev/null || echo "No default configs found"
            
            # Test Nginx configuration
            echo ""
            echo "=== Testing Nginx configuration ==="
            sudo nginx -t
            
            # Kill existing Gunicorn processes
            pkill -f gunicorn || true
            sleep 2
            
            # Create Gunicorn startup script
            printf '#!/bin/bash\ncd /var/www/flask-cicd-demo\nsource venv/bin/activate\ngunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 120 --access-logfile /var/www/flask-cicd-demo/gunicorn_access.log --error-logfile /var/www/flask-cicd-demo/gunicorn_error.log wsgi:app\n' > /var/www/flask-cicd-demo/start_gunicorn.sh
            
            chmod +x /var/www/flask-cicd-demo/start_gunicorn.sh
            
            # Start Gunicorn using the script
            cd /var/www/flask-cicd-demo
            echo "Starting Gunicorn..."
            nohup /var/www/flask-cicd-demo/start_gunicorn.sh > /var/www/flask-cicd-demo/gunicorn.log 2>&1 &
            GUNICORN_PID=$!
            echo "Gunicorn started with PID: $GUNICORN_PID"
            
            # Wait for Gunicorn to start
            sleep 8
            
            # Verify Gunicorn is running
            if pgrep -f "gunicorn.*wsgi:app" > /dev/null; then
              echo "✓ Gunicorn process is running"
              pgrep -af "gunicorn.*wsgi:app" | head -n 1
            else
              echo "✗ Gunicorn failed to start. Checking logs:"
              echo "=== Gunicorn Log ==="
              tail -n 30 /var/www/flask-cicd-demo/gunicorn.log 2>/dev/null || echo "No main log file"
              echo "=== Gunicorn Error Log ==="
              tail -n 30 /var/www/flask-cicd-demo/gunicorn_error.log 2>/dev/null || echo "No error log file"
              echo "Attempting direct start..."
              cd /var/www/flask-cicd-demo
              source venv/bin/activate
              gunicorn --bind 127.0.0.1:5000 --workers 2 wsgi:app > /var/www/flask-cicd-demo/gunicorn_direct.log 2>&1 &
              sleep 5
              pgrep -f gunicorn || echo "Still failed to start Gunicorn"
            fi
            
            # Verify Gunicorn is listening on port 5000
            echo "Verifying Gunicorn is responding..."
            for i in {1..10}; do
              if timeout 3 curl -s http://127.0.0.1:5000 > /dev/null 2>&1; then
                echo "✓ Gunicorn is responding on port 5000"
                curl -s http://127.0.0.1:5000 | head -c 100
                echo ""
                break
              else
                echo "Waiting for Gunicorn... ($i/10)"
                sleep 3
              fi
            done
            
            # Verify Gunicorn is running before restarting Nginx
            if ! pgrep -f gunicorn > /dev/null; then
              echo "⚠ WARNING: Gunicorn is not running! Check logs above."
              tail -n 30 /var/www/flask-cicd-demo/gunicorn.log 2>/dev/null || true
            fi
            
            # Restart Nginx
            sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null
            sudo systemctl enable nginx 2>/dev/null || sudo chkconfig nginx on 2>/dev/null
            
            # Wait a moment for Nginx to restart
            sleep 3
            
            # Verify Nginx is serving Flask (not default page)
            echo "=== Verifying Nginx is proxying to Flask ==="
            timeout 3 curl -s http://127.0.0.1:80 | head -c 100 || echo "Nginx test failed"
            echo ""
            
            # Quick final verification (with timeouts to prevent hanging)
            echo "=== Quick Status Check ==="
            timeout 2 pgrep -af gunicorn 2>/dev/null | head -n 1 || echo "Gunicorn check skipped"
            timeout 2 curl -s http://127.0.0.1:5000 2>/dev/null | head -c 50 && echo "..." || echo "Port 5000 check skipped"
            timeout 2 curl -s http://127.0.0.1:80 2>/dev/null | head -c 50 && echo "..." || echo "Port 80 check skipped"
            
            echo ""
            echo "=== Deployment completed successfully ==="
            
            # Ensure clean exit (background processes will continue)
            exit 0

