name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p $HOME/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > $HOME/.ssh/ec2_key.pem
          chmod 600 $HOME/.ssh/ec2_key.pem
          ls -la $HOME/.ssh/
          cat $HOME/.ssh/ec2_key.pem | head -n 1

      - name: Deploy to EC2
        continue-on-error: true
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key_path: /home/runner/.ssh/ec2_key.pem
          port: 22
          command_timeout: 30m
          script_stop: false
          debug: true
          script: |
            echo "Starting deployment..."
            
            # Install required dependencies
            if ! command -v git &> /dev/null; then
              echo "Installing git..."
              sudo yum install -y git || sudo apt-get install -y git
            fi
            
            if ! command -v python3 &> /dev/null; then
              echo "Installing Python3..."
              sudo yum install -y python3 python3-pip || sudo apt-get install -y python3 python3-pip python3-venv
            fi
            
            # Navigate to project directory (create if doesn't exist)
            if [ ! -d "/var/www/flask-cicd-demo" ]; then
              sudo mkdir -p /var/www
              cd /var/www
              sudo git clone https://github.com/${{ github.repository }}.git flask-cicd-demo
              sudo chown -R ec2-user:ec2-user /var/www/flask-cicd-demo
            fi
            
            cd /var/www/flask-cicd-demo
            git pull origin main || true
            
            # Setup virtual environment if doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
              # Fix permissions
              chmod +x venv/bin/activate
            fi
            
            source venv/bin/activate
            
            # Upgrade pip and install requirements
            pip install --upgrade pip || pip3 install --upgrade pip || python3 -m pip install --upgrade pip
            pip install -r requirements.txt || pip3 install -r requirements.txt || python3 -m pip install -r requirements.txt
            
            # Install Nginx and curl if not installed (Amazon Linux)
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo yum update -y || sudo apt update -y
              sudo yum install -y nginx || sudo apt install -y nginx
            fi
            
            if ! command -v curl &> /dev/null; then
              echo "Installing curl..."
              sudo yum install -y curl || sudo apt install -y curl
            fi
            
            # Remove conflicting Nginx configs first
            sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            sudo rm -f /etc/nginx/conf.d/flask.conf 2>/dev/null || true
            
            # Configure Nginx
            sudo tee /etc/nginx/conf.d/flask.conf > /dev/null <<EOF
            server {
                listen 80;
                server_name localhost;
                
                location / {
                    proxy_pass http://127.0.0.1:5000;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF
            
            # Test Nginx configuration
            sudo nginx -t
            
            # Kill existing Gunicorn processes
            pkill -f gunicorn || true
            sleep 1
            
            # Start Gunicorn in background
            cd /var/www/flask-cicd-demo
            source venv/bin/activate
            GUNICORN_CMD=$(which gunicorn)
            echo "Starting Gunicorn from: $GUNICORN_CMD"
            
            nohup $GUNICORN_CMD --bind 127.0.0.1:5000 --workers 2 --timeout 120 wsgi:app > gunicorn.log 2>&1 &
            sleep 3
            
            # Quick check if Gunicorn is running
            if pgrep -f gunicorn > /dev/null; then
              echo "✓ Gunicorn process started"
            else
              echo "⚠ Gunicorn process check failed, but continuing..."
              tail -n 5 gunicorn.log 2>/dev/null || true
            fi
            
            # Quick test if Gunicorn responds
            timeout 3 curl -s http://127.0.0.1:5000 > /dev/null && echo "✓ Gunicorn responding" || echo "⚠ Gunicorn may still be starting"
            
            # Restart Nginx
            sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null
            sudo systemctl enable nginx 2>/dev/null || sudo chkconfig nginx on 2>/dev/null
            
            # Quick final verification (with timeouts to prevent hanging)
            echo "=== Quick Status Check ==="
            timeout 2 pgrep -af gunicorn 2>/dev/null | head -n 1 || echo "Gunicorn check skipped"
            timeout 2 curl -s http://127.0.0.1:5000 2>/dev/null | head -c 50 && echo "..." || echo "Port 5000 check skipped"
            timeout 2 curl -s http://127.0.0.1:80 2>/dev/null | head -c 50 && echo "..." || echo "Port 80 check skipped"
            
            echo ""
            echo "=== Deployment completed successfully ==="
            
            # Ensure clean exit (background processes will continue)
            exit 0

