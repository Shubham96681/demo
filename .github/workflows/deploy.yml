name: Deploy Flask App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p $HOME/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > $HOME/.ssh/ec2_key.pem
          chmod 600 $HOME/.ssh/ec2_key.pem
          ls -la $HOME/.ssh/
          cat $HOME/.ssh/ec2_key.pem | head -n 1

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key_path: /home/runner/.ssh/ec2_key.pem
          timeout: 30s
          debug: true
          script: |
            # Install required dependencies
            if ! command -v git &> /dev/null; then
              echo "Installing git..."
              sudo yum install -y git || sudo apt-get install -y git
            fi
            
            if ! command -v python3 &> /dev/null; then
              echo "Installing Python3..."
              sudo yum install -y python3 python3-pip || sudo apt-get install -y python3 python3-pip python3-venv
            fi
            
            # Navigate to project directory (create if doesn't exist)
            if [ ! -d "/var/www/flask-cicd-demo" ]; then
              sudo mkdir -p /var/www
              cd /var/www
              sudo git clone https://github.com/${{ github.repository }}.git flask-cicd-demo
              sudo chown -R ec2-user:ec2-user /var/www/flask-cicd-demo
            fi
            
            cd /var/www/flask-cicd-demo
            git pull origin main || true
            
            # Setup virtual environment if doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
              # Fix permissions
              chmod +x venv/bin/activate
            fi
            
            source venv/bin/activate
            
            # Upgrade pip and install requirements
            pip install --upgrade pip || pip3 install --upgrade pip || python3 -m pip install --upgrade pip
            pip install -r requirements.txt || pip3 install -r requirements.txt || python3 -m pip install -r requirements.txt
            
            # Install Nginx and curl if not installed (Amazon Linux)
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo yum update -y || sudo apt update -y
              sudo yum install -y nginx || sudo apt install -y nginx
            fi
            
            if ! command -v curl &> /dev/null; then
              echo "Installing curl..."
              sudo yum install -y curl || sudo apt install -y curl
            fi
            
            # Configure Nginx
            sudo tee /etc/nginx/conf.d/flask.conf > /dev/null <<EOF
            server {
                listen 80;
                server_name _;
                
                location / {
                    proxy_pass http://127.0.0.1:5000;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF
            
            # Remove default Nginx site if exists
            sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            # Test Nginx configuration
            sudo nginx -t
            
            # Kill existing Gunicorn processes
            pkill -f gunicorn || true
            sleep 2
            
            # Start Gunicorn in background with proper error handling
            cd /var/www/flask-cicd-demo
            source venv/bin/activate
            # Use full path to gunicorn and ensure proper environment
            GUNICORN_CMD=$(which gunicorn)
            echo "Gunicorn location: $GUNICORN_CMD"
            nohup $GUNICORN_CMD --bind 127.0.0.1:5000 --workers 2 --timeout 120 --access-logfile - --error-logfile - wsgi:app > gunicorn.log 2>&1 &
            GUNICORN_PID=$!
            sleep 5
            
            # Check if Gunicorn started successfully
            if ps -p $GUNICORN_PID > /dev/null 2>&1 || pgrep -f gunicorn > /dev/null; then
              echo "Gunicorn started successfully (PID: $GUNICORN_PID)"
            else
              echo "Gunicorn failed to start. Checking logs:"
              cat gunicorn.log || echo "No log file found"
              echo "Attempting to start with full path..."
              # Try starting again with full path
              cd /var/www/flask-cicd-demo
              source venv/bin/activate
              $GUNICORN_CMD --bind 127.0.0.1:5000 --workers 2 wsgi:app > gunicorn2.log 2>&1 &
              sleep 3
              pgrep -f gunicorn || echo "Still failed to start Gunicorn"
            fi
            
            # Wait a bit more and verify Gunicorn is responding
            sleep 2
            if curl -s http://127.0.0.1:5000 > /dev/null; then
              echo "✓ Gunicorn is responding on port 5000"
            else
              echo "✗ Gunicorn is not responding on port 5000"
            fi
            
            # Now restart Nginx (after Gunicorn is running)
            sudo systemctl restart nginx || sudo service nginx restart
            sudo systemctl enable nginx || sudo chkconfig nginx on
            
            # Verify services are running
            echo "=== Gunicorn Status ==="
            pgrep -af gunicorn || ps aux | grep gunicorn | grep -v grep
            echo ""
            echo "=== Gunicorn Log (last 20 lines) ==="
            tail -n 20 gunicorn.log 2>/dev/null || echo "No log file yet"
            echo ""
            echo "=== Port 5000 Status ==="
            netstat -tlnp | grep 5000 || ss -tlnp | grep 5000 || echo "Port 5000 check skipped"
            echo ""
            echo "=== Testing Gunicorn directly ==="
            curl -v http://127.0.0.1:5000 2>&1 | head -n 10 || echo "Gunicorn not responding on port 5000"
            echo ""
            echo "=== Nginx Status ==="
            sudo systemctl status nginx --no-pager || sudo service nginx status
            echo ""
            echo "=== Port 80 Status ==="
            netstat -tlnp | grep :80 || ss -tlnp | grep :80 || echo "Port 80 check skipped"
            echo ""
            echo "=== Nginx Error Log (last 10 lines) ==="
            sudo tail -n 10 /var/log/nginx/error.log 2>/dev/null || echo "No error log found"
            echo ""
            echo "=== Testing through Nginx ==="
            curl -v http://127.0.0.1:80 2>&1 | head -n 10 || echo "Nginx test failed"

